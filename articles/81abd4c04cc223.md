---
title: "ローカルDNSをたてる"
emoji: "🦁"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["dnsmasq", "dns"]
published: false
---

## はじめに

Dnsmasqを用いて、家庭内で使用するローカルDNSを構築するための手順を示す。

### 想定の環境

* 家庭用ルータが10.0.0.1/8にある。
  * ここがデフォルトゲートウェイかつDNSの役割として担っている。
  * DHCPによるIP配布はここからのみ行う。
* WikiサーバとWebサーバがあり、ここにそれぞれ名前経由でアクセスできるようにしたい。
* DNSサーバはローカルの名前解決のみを行い、それ以外は家庭用ルータによる名前解決を行う。

![構成図](/images/81abd4c04cc223/dns_image.png)

IPアドレスとドメイン名の対応は以下の通りとする。

|サーバ名|IPアドレス|ドメイン名|
|- |- |- |
|Wikiサーバ |10.255.0.1/8|wiki.local|
|Webサーバ  |10.255.1.1/8|web.local|


### 基本的な方針

* Ubuntu Server 22.04にDnsmasqを導入する。
  * DNS機能のみ用いて、DHCP機能は使用しない。
* ホストの追加は`/etc/hosts`に追記して、シェルスクリプトによる更新をする方針をとる。
* サーバの冗長構成は取らない。
  * 個別のテーマとして扱うかも。



## サーバ構築手順

### 事前準備

#### ポート 53 を使用しているプロセスの確認

以下のコマンドを実行して、ポート 53 を使用しているプロセスを確認します。

```bash:terminal
sudo lsof -i :53
```

このコマンドの出力には、ポート 53 を使用しているプロセスのリストが表示される。　　
通常、他の DNS サーバ（systemd-resolved や bind など）がこのポートを使用している可能性がある。

プリインストール後はsystemd-resolvedが稼働している可能性が高い。  
今回は以下の通り出力された。

```
COMMAND   PID            USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
systemd-r 617 systemd-resolve   13u  IPv4  19996      0t0  UDP localhost:domain
systemd-r 617 systemd-resolve   14u  IPv4  19997      0t0  TCP localhost:domain (LISTEN)
```

#### systemd-resolved の停止

もし systemd-resolved がポート 53 を使用している場合、以下のコマンドで停止できる。

```bash:terminal
sudo systemctl stop systemd-resolved
```

その後、/etc/systemd/resolved.conf ファイルを編集し、DNSStubListener を無効にする。

```bash:terminal
sudo vi /etc/systemd/resolved.conf
```

以下の行を変更または追加する。

```
DNSStubListener=no
```

設定を保存してファイルを閉じた後、以下のコマンドを実行してリゾルバー設定を更新します。

```bash:terminal
sudo systemctl restart systemd-resolved
```

### dnsmasqの導入

#### dnsmasq のインストール

まず、Ubuntu Server 22.04に dnsmasq をインストールする。

```bash:terminal
sudo apt update
sudo apt install -y dnsmasq
```

#### dnsmasq の設定

まずは以下のコマンドで、ゲートウェイになるインターフェースを確認する。

```bash
ip addr
```

ここで確認した結果、該当のインターフェースは`ens18`であった。

`/etc/dnsmasq.conf` ファイルを編集する。
オリジナルのファイルを保存したうえで、新規ファイルを作成する形をとる。

```bash
sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig
sudo vi /etc/dnsmasq.conf
```

```
################################
# 共通設定
################################

# 特定のインターフェースにのみバインドする
bind-interfaces

# 使用するインターフェースを指定
interface=ens18

# DNSサーバのIPアドレス
listen-address=10.255.0.4

# Dnsmasqがlistenするポート
port=53


################################
# DNSサーバの設定
################################

# 上位DNSサーバの設定
server=10.0.0.1

# プライベートIPアドレスの逆引き設定
bogus-nxdomain=10.0.0.0/8

# dnsmasqでキャッシュするレコード数
# 0にするとキャッシュしない
cache-size=0

# 名前解決の設定(外部ファイルを読み込む)
conf-file=/etc/dnsmasq.d/hosts.conf

# サーバ上の/etc/hostsで名前解決をさせない
no-hosts


# ドメイン名のないクエリに自動的にドメイン（144行目, domain=で記述）を付与する
expand-hosts
# 内部ドメインとしてlocalを使用
domain=local

# DNSクエリに対してのログを出力する
# log-querie

# ログの出力場所
# log-facility=/var/log/dnsmasq/dnsmasq.log


################################
# DHCPサーバの設定
################################

# DHCPを無効化するインターフェースを指定
no-dhcp-interface=ens18
```

### generate_hosts.shの作成

generate_hosts.shというスクリプトにより、Dnsmasqが用いるホストファイル群を生成する。  
ファイルを以下の通り作成する。

```bash:terminal
touch ~/generate_hosts.sh
chmod 755 ~/generate_hosts.sh
vi ~/generate_hosts.sh
```

```bash
#!/bin/bash

# 出力ファイル
output_file="/etc/dnsmasq.d/hosts.conf"

# 初期化
echo "# Generated by generate_address.sh" | sudo tee $output_file > /dev/null

# /etc/hosts からエントリを抽出して /etc/dnsmasq.d/hosts.conf に書き込み
grep -v '^#' /etc/hosts \
  | grep -v '^$' \
  | grep -v 'ip6-' \
  | grep -v '^127\.0' \
  | awk '{print "address=/" $2 "/" $1}' \
  | sudo tee -a $output_file > /dev/null

echo "Configuration has been written to $output_file"
```

## ホストファイルの設定

ここからは本記事の運用面のお話になる。  
ホストの追加を行う場合は、このセクションにある通りの作業を行うこととなる。


### /etc/hostsへの追加

/etc/hosts ファイルに以下のエントリを追加して、ローカル名前解決を行います。

```bash:terminal
sudo vi /etc/hosts
```

今回は以下の通りとした。

```
10.255.0.1 wiki.local
10.255.1.1 web.local

# 以下original
127.0.0.1 localhost
127.0.1.1 testvm001

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

### /etc/dnsmasq.d/hosts.confへの反映

先ほど作成したスクリプトを用いて、/etc/dnsmasq.d/hosts.conf に反映する。

```bash:terminal
~/generate_hosts.sh
```

これにより、以下の通りとなる。

```bash:terminal
cat /etc/dnsmasq.d/hosts.conf
```

```
# Generated by generate_address.sh
address=/wiki.local/10.255.0.1
address=/web.local/10.255.1.1
```

### dnsmasq の再起動

設定が完了したら、dnsmasq を再起動して設定を反映させます。

```bash:termnal
sudo systemctl restart dnsmasq
```

### 動作確認

#### DNSサーバ上の確認

nslookup または dig コマンドを使用して、名前解決が正しく動作しているか確認します。

```bash:terminal
nslookup wiki.local 10.255.0.1
nslookup web.local 10.255.1.1
```

これで、dnsmasq を使用して家庭内LANの設定が完了となり、名前解決とDHCP機能が正しく動作するはずである。

#### クライアント端末上の確認

まずはクライアント端末のDNSの設定として、DNSサーバ（10.255.255.2）を優先DNSとして設定していない場合は、その設定を行う。

そのうえで、webブラウザから、以下の通りアクセスできることを確認する。  
（サーバの種類によって、httpsにしたり、ドメインを除いたパスも適切に指定する必要あり）

* wikiサーバの確認: `http://wiki.local`
* webサーバの確認: `http://web.local`


もしアクセスできない場合は、nslookupコマンドを実行し、状況を確認する。

```
>nslookup wiki.local 10.255.255.2
サーバー:  UnKnown
Address:  10.255.255.2

名前:    wiki.local
Address:  10.255.0.1
```


