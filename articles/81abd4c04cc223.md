---
title: "ãƒ­ãƒ¼ã‚«ãƒ«DNSã‚’ãŸã¦ã‚‹"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["dnsmasq", "dns"]
published: true
---

## ã¯ã˜ã‚ã«

Dnsmasqã‚’ç”¨ã„ã¦ã€å®¶åº­å†…ã§ä½¿ç”¨ã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«DNSã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®æ‰‹é †ã‚’ç¤ºã™ã€‚

### æƒ³å®šã®ç’°å¢ƒ

* å®¶åº­ç”¨ãƒ«ãƒ¼ã‚¿ãŒ10.0.0.1/8ã«ã‚ã‚‹ã€‚
  * ã“ã“ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‹ã¤DNSã®å½¹å‰²ã¨ã—ã¦æ‹…ã£ã¦ã„ã‚‹ã€‚
  * DHCPã«ã‚ˆã‚‹IPé…å¸ƒã¯ã“ã“ã‹ã‚‰ã®ã¿è¡Œã†ã€‚
* Wikiã‚µãƒ¼ãƒã¨Webã‚µãƒ¼ãƒãŒã‚ã‚Šã€ã“ã“ã«ãã‚Œãã‚Œåå‰çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚
* DNSã‚µãƒ¼ãƒã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®åå‰è§£æ±ºã®ã¿ã‚’è¡Œã„ã€ãã‚Œä»¥å¤–ã¯å®¶åº­ç”¨ãƒ«ãƒ¼ã‚¿ã«ã‚ˆã‚‹åå‰è§£æ±ºã‚’è¡Œã†ã€‚

![æ§‹æˆå›³](/images/81abd4c04cc223/dns_image.png)

IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³åã®å¯¾å¿œã¯ä»¥ä¸‹ã®é€šã‚Šã¨ã™ã‚‹ã€‚

|ã‚µãƒ¼ãƒå|IPã‚¢ãƒ‰ãƒ¬ã‚¹|ãƒ‰ãƒ¡ã‚¤ãƒ³å|
|- |- |- |
|Wikiã‚µãƒ¼ãƒ |10.255.0.1/8|wiki.local|
|Webã‚µãƒ¼ãƒ  |10.255.1.1/8|web.local|


### åŸºæœ¬çš„ãªæ–¹é‡

* Ubuntu Server 22.04ã«Dnsmasqã‚’å°å…¥ã™ã‚‹ã€‚
  * DNSæ©Ÿèƒ½ã®ã¿ç”¨ã„ã¦ã€DHCPæ©Ÿèƒ½ã¯ä½¿ç”¨ã—ãªã„ã€‚
* åå‰è§£æ±ºå¯¾è±¡ã®ãƒ›ã‚¹ãƒˆã¯ã€å€‹åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒªã‚¹ãƒˆã¨ã—ã¦è¨˜è¼‰ã™ã‚‹ã€‚
* ã‚µãƒ¼ãƒã®å†—é•·æ§‹æˆã¯å–ã‚‰ãªã„ã€‚
  * å€‹åˆ¥ã®ãƒ†ãƒ¼ãƒã¨ã—ã¦æ‰±ã†ã‹ã‚‚ã€‚

### Dnsmasq ã®åŸºæœ¬çš„ãªå‹•ä½œ

dnsmasqã¯debãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å°å…¥ã™ã‚Œã°ä½¿ãˆã‚‹ã€‚  

`/etc/dnsmasq.conf`ã«ã™ã¹ã¦ã®è¨­å®šã‚’è¨˜è¿°ã™ã‚‹ãŒã€å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¯¾å¿œã—ã¦ã„ã‚‹ã€‚  
ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ã€DNSã«ã‚ˆã‚‹åå‰è§£æ±ºã®å¯¾è±¡ã¨ã—ãŸã„IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨åå‰ã®å¯¾å¿œã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™ã‚‚ã®ã¨ã—ã€ãã®åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã§ã¯ `/etc/dnsmasq.d/addresses.conf` ã¨ã™ã‚‹ã€‚

åå‰è§£æ±ºã•ã›ãŸã„ãƒ›ã‚¹ãƒˆã«å¤‰æ›´ãŒç”Ÿã˜ã‚‹ãŸã³ã€`/etc/dnsmasq.d/addresses.conf`ã®è¨­å®šã‚’å¤‰æ›´ã—ã€dnsmasqã®å†èµ·å‹•ã‚’è¡Œã†ã€‚
ãã†ã™ã‚‹ã“ã¨ã§ã€æœ€æ–°ã®å¯¾å¿œã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚


## ã‚µãƒ¼ãƒæ§‹ç¯‰æ‰‹é †

### äº‹å‰æº–å‚™

#### ãƒãƒ¼ãƒˆ 53 ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã®ç¢ºèª

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ãƒãƒ¼ãƒˆ 53 ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash:terminal
sudo lsof -i :53
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›ã«ã¯ã€ãƒãƒ¼ãƒˆ 53 ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚ã€€ã€€
é€šå¸¸ã€ä»–ã® DNS ã‚µãƒ¼ãƒï¼ˆsystemd-resolved ã‚„ bind ãªã©ï¼‰ãŒã“ã®ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã¯systemd-resolvedãŒç¨¼åƒã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã€‚  
ä»Šå›ã¯ä»¥ä¸‹ã®é€šã‚Šå‡ºåŠ›ã•ã‚ŒãŸã€‚

```
COMMAND   PID            USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
systemd-r 617 systemd-resolve   13u  IPv4  19996      0t0  UDP localhost:domain
systemd-r 617 systemd-resolve   14u  IPv4  19997      0t0  TCP localhost:domain (LISTEN)
```

#### systemd-resolved ã®åœæ­¢

ã‚‚ã— systemd-resolved ãŒãƒãƒ¼ãƒˆ 53 ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§åœæ­¢ã§ãã‚‹ã€‚

```bash:terminal
sudo systemctl stop systemd-resolved
```

ãã®å¾Œã€/etc/systemd/resolved.conf ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã€DNSStubListener ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã€‚

```bash:terminal
sudo vi /etc/systemd/resolved.conf
```

ä»¥ä¸‹ã®è¡Œã‚’å¤‰æ›´ã¾ãŸã¯è¿½åŠ ã™ã‚‹ã€‚

```
DNSStubListener=no
```

è¨­å®šã‚’ä¿å­˜ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‰ã˜ãŸå¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒªã‚¾ãƒ«ãƒãƒ¼è¨­å®šã‚’æ›´æ–°ã—ã¾ã™ã€‚

```bash:terminal
sudo systemctl restart systemd-resolved
```

### dnsmasqã®å°å…¥

#### dnsmasq ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¾ãšã€Ubuntu Server 22.04ã« dnsmasq ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```bash:terminal
sudo apt update
sudo apt install -y dnsmasq
```

#### dnsmasq ã®è¨­å®š

ã¾ãšã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã«ãªã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç¢ºèªã™ã‚‹ã€‚

```bash
ip addr
```

ã“ã“ã§ç¢ºèªã—ãŸçµæœã€è©²å½“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯`ens18`ã§ã‚ã£ãŸã€‚

`/etc/dnsmasq.conf` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹ã€‚
ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ãŸã†ãˆã§ã€æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹å½¢ã‚’ã¨ã‚‹ã€‚

```bash
sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig
sudo vi /etc/dnsmasq.conf
```

```
################################
# å…±é€šè¨­å®š
################################

# ç‰¹å®šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã®ã¿ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹
bind-interfaces

# ä½¿ç”¨ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æŒ‡å®š
interface=ens18

# DNSã‚µãƒ¼ãƒã®IPã‚¢ãƒ‰ãƒ¬ã‚¹
listen-address=10.255.255.2

# DnsmasqãŒlistenã™ã‚‹ãƒãƒ¼ãƒˆ
port=53


################################
# DNSã‚µãƒ¼ãƒã®è¨­å®š
################################

# ä¸Šä½DNSã‚µãƒ¼ãƒã®è¨­å®š
server=10.0.0.1

# ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã®é€†å¼•ãè¨­å®š
bogus-nxdomain=10.0.0.0/8

# dnsmasqã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°
# 0ã«ã™ã‚‹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„
cache-size=0

# åå‰è§£æ±ºã®è¨­å®š(å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€)
conf-file=/etc/dnsmasq.d/addresses.conf

# ã‚µãƒ¼ãƒä¸Šã®/etc/hostsã§åå‰è§£æ±ºã‚’ã•ã›ãªã„
no-hosts


# ãƒ‰ãƒ¡ã‚¤ãƒ³åã®ãªã„ã‚¯ã‚¨ãƒªã«è‡ªå‹•çš„ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä»˜ä¸ã™ã‚‹
expand-hosts
# å†…éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦localã‚’ä½¿ç”¨
domain=local

# DNSã‚¯ã‚¨ãƒªã«å¯¾ã—ã¦ã®ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹
# log-querie

# ãƒ­ã‚°ã®å‡ºåŠ›å ´æ‰€
# log-facility=/var/log/dnsmasq/dnsmasq.log


################################
# DHCPã‚µãƒ¼ãƒã®è¨­å®š
################################

# DHCPã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æŒ‡å®š
no-dhcp-interface=ens18
```

## ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°

ã“ã“ã‹ã‚‰ã¯æœ¬è¨˜äº‹ã®é‹ç”¨é¢ã®ãŠè©±ã«ãªã‚‹ã€‚  
ãƒ›ã‚¹ãƒˆã®è¿½åŠ ã‚’è¡Œã†å ´åˆã¯ã€ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ã‚‹é€šã‚Šã®ä½œæ¥­ã‚’è¡Œã†ã“ã¨ã¨ãªã‚‹ã€‚

### /etc/dnsmasq.d/addresses.confã¸ã®åæ˜ 

`/etc/dnsmasq.d/addresses.conf` ã«åå‰ã¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åæ˜ ã™ã‚‹ã€‚


```bash:terminal
sudo vi /etc/dnsmasq.d/addresses.conf
```

```
address=/wiki.local/10.255.0.1
address=/web.local/10.255.1.1
```

### dnsmasq ã®å†èµ·å‹•

è¨­å®šãŒå®Œäº†ã—ãŸã‚‰ã€dnsmasq ã‚’å†èµ·å‹•ã—ã¦è¨­å®šã‚’åæ˜ ã•ã›ã¾ã™ã€‚

```bash:termnal
sudo systemctl restart dnsmasq
```

### å‹•ä½œç¢ºèª

#### DNSã‚µãƒ¼ãƒä¸Šã®ç¢ºèª

nslookup ã¾ãŸã¯ dig ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€åå‰è§£æ±ºãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

```bash:terminal
nslookup wiki.local 10.255.255.2
nslookup web.local 10.255.255.2
```

ã“ã‚Œã§ã€dnsmasq ã‚’ä½¿ç”¨ã—ã¦å®¶åº­å†…LANã®è¨­å®šãŒå®Œäº†ã¨ãªã‚Šã€åå‰è§£æ±ºã¨DHCPæ©Ÿèƒ½ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã¯ãšã§ã‚ã‚‹ã€‚

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç«¯æœ«ä¸Šã®ç¢ºèª

ã¾ãšã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç«¯æœ«ã®DNSã®è¨­å®šã¨ã—ã¦ã€DNSã‚µãƒ¼ãƒï¼ˆ10.255.255.2ï¼‰ã‚’å„ªå…ˆDNSã¨ã—ã¦è¨­å®šã—ã¦ã„ãªã„å ´åˆã¯ã€ãã®è¨­å®šã‚’è¡Œã†ã€‚

ãã®ã†ãˆã§ã€webãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã€ä»¥ä¸‹ã®é€šã‚Šã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚  
ï¼ˆã‚µãƒ¼ãƒã®ç¨®é¡ã«ã‚ˆã£ã¦ã€httpsã«ã—ãŸã‚Šã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’é™¤ã„ãŸãƒ‘ã‚¹ã‚‚é©åˆ‡ã«æŒ‡å®šã™ã‚‹å¿…è¦ã‚ã‚Šï¼‰

* wikiã‚µãƒ¼ãƒã®ç¢ºèª: `http://wiki.local`
* webã‚µãƒ¼ãƒã®ç¢ºèª: `http://web.local`


ã‚‚ã—ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å ´åˆã¯ã€nslookupã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€çŠ¶æ³ã‚’ç¢ºèªã™ã‚‹ã€‚

```
>nslookup wiki.local 10.255.255.2
ã‚µãƒ¼ãƒãƒ¼:  UnKnown
Address:  10.255.255.2

åå‰:    wiki.local
Address:  10.255.0.1
```


