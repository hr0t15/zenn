---
title: "ã‚ªãƒ¬ã‚ªãƒ¬èªè¨¼å±€ã®ä½œã‚Šæ–¹"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["openssl"]
published: false
---

OpenSSLã‚’ä½¿ç”¨ã—ã¦èªè¨¼å±€ (CA; Certificate Authorities) ã‚’ä½œæˆã—ã€è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ç™ºè¡Œã™ã‚‹ã‚ªãƒ¬ã‚ªãƒ¬èªè¨¼å±€ï¼ˆè‡ªåˆ†è‡ªèº«ã®èªè¨¼å±€ï¼‰ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ç°¡å˜ãªæ‰‹é †ã‚’èª¬æ˜ã™ã‚‹ã€‚  
ãŸã ã—ã€ã“ã‚Œã¯æ•™è‚²ã‚„å®Œå…¨ãªãƒ­ãƒ¼ã‚«ãƒ«åˆ©ç”¨ã‚’ç›®çš„ã¨ã—ãŸå ´åˆã®ã¿ä½¿ç”¨ã—ã€å®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚

Ubuntu Server 22.04ã‚’ä»®å®šã™ã‚‹ã€‚

```mermaid
sequenceDiagram
   participant Client
   participant Server
   participant CA

   Client->>Server: SSL/TLSæ¥ç¶šè¦æ±‚
   Server->>Client: ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã‚’é€ä¿¡
   Client->>CA: ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã®æ¤œè¨¼è¦æ±‚
   CA->>CA: ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã®æ¤œè¨¼
   alt æ¤œè¨¼æˆåŠŸ
       CA->>Client: æ¤œè¨¼çµæœï¼ˆæˆåŠŸï¼‰ã‚’è¿”ã™
       Client->>Server: SSL/TLSæ¥ç¶šã‚’ç¢ºç«‹
   else æ¤œè¨¼å¤±æ•—
       CA->>Client: æ¤œè¨¼çµæœï¼ˆå¤±æ•—ï¼‰ã‚’è¿”ã™
       Client->>Client: SSL/TLSæ¥ç¶šã‚’ä¸­æ­¢
   end
```

## å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash:terminal
sudo apt update
sudo apt install openssl
```


## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š

èªè¨¼å±€ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚

```bash:terminal
mkdir -p ~/myCA/{certs,crl,newcerts,private}
mkdir -p ~/myCA/{certs,crl,newcerts,private}
cd ~/myCA
```

## CAã®ç§˜å¯†éµã®ç”Ÿæˆ

ã“ã“ã§ã¯4096ãƒ“ãƒƒãƒˆã®RSAç§˜å¯†éµã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```bash:terminal
openssl genpkey         \
  -algorithm RSA        \
  -out private/myCA.key \
  -aes256 4096
```

aes256ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯éµã‚’æš—å·åŒ–ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã€ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã®å…¥åŠ›ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚


## CAã®è‡ªå·±ç½²åè¨¼æ˜æ›¸ã®ç”Ÿæˆ

æ¬¡ã«ã€èªè¨¼å±€ã®è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```bash:terminal
openssl req              \
  -x509 -new -nodes      \
  -key private/myCA.key  \
  -sha256                \
  -days 3650             \
  -out certs/myCA.crt
```

ã“ã“ã§ã€æ§˜ã€…ãªæƒ…å ±ï¼ˆå›½ã€éƒ½é“åºœçœŒã€å¸‚åŒºç”ºæ‘ã€çµ„ç¹”åã€å…±é€šåãªã©ï¼‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚å…±é€šåï¼ˆCNï¼‰ã«ã¯èªè¨¼å±€ã®åå‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

## ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã®ç§˜å¯†éµã®ç”Ÿæˆ

èªè¨¼å±€ã‚’ä½¿ç”¨ã—ã¦ç½²åã™ã‚‹ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã®ç§˜å¯†éµã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```bash:terminal
openssl genpkey  \
  -algorithm RSA \
  -out private/server.key  \
  -aes256
```

## ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã®ç½²åè¦æ±‚ï¼ˆCSRï¼‰ã®ç”Ÿæˆ

ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã®ç½²åè¦æ±‚ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```bash:terminal
openssl req -new -key private/server.key -out server.csr
```

## ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã®ç™ºè¡Œ

CAãŒCSRã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ã¾ã™ã€‚

```bash:terminal
openssl x509 -req -in server.csr -CA certs/myCA.crt -CAkey private/myCA.key -CAcreateserial -out certs/server.crt -days 365 -sha256
```

## è¨¼æ˜æ›¸ã®ç¢ºèª

ç™ºè¡Œã•ã‚ŒãŸè¨¼æ˜æ›¸ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash:terminal
openssl x509 -in certs/server.crt -text -noout
```

ã“ã‚Œã§ã€ã‚ªãƒ¬ã‚ªãƒ¬èªè¨¼å±€ã«ã‚ˆã£ã¦ç™ºè¡Œã•ã‚ŒãŸè‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’æŒã¤ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚  
èªè¨¼å±€ã®è¨¼æ˜æ›¸ï¼ˆmyCA.crtï¼‰ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã§ã€ã“ã®ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã‚’ä¿¡é ¼ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

è¨¼æ˜æ›¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹éš›ã¯ã€ä½¿ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šã«å¿œã˜ã¦é©åˆ‡ã«é…ç½®ã—ã¦ãã ã•ã„ã€‚

