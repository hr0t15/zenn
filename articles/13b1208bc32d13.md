---
title: "MLFlow Trackingã®ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ç’°å¢ƒã¸ã®å°å…¥(PostgreSQL + MinIO)"
emoji: "ğŸ˜º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["mlflow"]
published: false
---

# ã¯ã˜ã‚ã«

MLFlow Trackingã®ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ç’°å¢ƒã¸ã®å°å…¥ã‚’è¡Œã†ã€‚  
OSã¯Ubuntu Server 22.04ã¨ã—ã€ä»¥ä¸‹ã®æ§‹æˆã‚’ã¨ã‚‹ã€‚  

* ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã—ã¦MinIOã‚’å°å…¥ã™ã‚‹ã€‚
* MLFlow Serverã¯ã€ã“ã“ã§ã¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ãã®ã‚‚ã®ã‚’æŒ‡ã™ã‚‚ã®ã¨ã—ã€PostgreSQLã‚’æ¡ç”¨ã™ã‚‹ã€‚
* MLFlow Clientã«ã‚ˆã‚‹å®Ÿé¨“çµæœã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’MLFLow Serverã«æ ¼ç´ã—ã€artifactã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æ ¼ç´ã™ã‚‹ã‚‚ã®ã¨ã™ã‚‹ã€‚
* MLFLow ServerãŠã‚ˆã³MLFLow Clientã«ã¯Python3.11ãŠã‚ˆã³å¯¾å¿œã™ã‚‹pipãŒå°å…¥ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨ã™ã‚‹ã€‚

å…¨ä½“çš„ãªæ§‹æˆã¯ä»¥ä¸‹ã®é€šã‚Šã¨ä»®å®šã™ã‚‹ã€‚

![](/images/13b1208bc32d13/kousei.png)


# MinIOã®å°å…¥è¨­å®š

## MinIOã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨æ›´æ–°

ã‚·ã‚¹ãƒ†ãƒ ã‚’æœ€æ–°ã®çŠ¶æ…‹ã«æ›´æ–°ã—ã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```bash
sudo apt update
sudo apt install -y wget
```

### MinIOã®å–å¾—

MinIOã®å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰æœ€æ–°ã®ãƒã‚¤ãƒŠãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒã‚¤ãƒŠãƒªã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸ã—ãŸã†ãˆã§`/usr/local/bin`ã«ç§»å‹•ã™ã‚‹ã€‚

```bash
wget https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio
sudo mv minio /usr/local/bin
```

### MinIOã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ

MinIOãŒãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª`/opt/minio/data`ã‚’ä½œæˆã™ã‚‹ã€‚

```bash
sudo mkdir -p /opt/minio/data
```

## MinIOã®å®Ÿè¡Œ

### MinIOã®èµ·å‹•

MinIOã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•ã™ã‚‹ã€‚  
ãƒãƒ¼ãƒˆ9000ã‚’ä½¿ç”¨ã—ã€æŒ‡å®šã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã€‚

```bash
sudo minio server /opt/minio/data &
```

ã“ã®æ™‚ç‚¹ã§MinIOã¯ãƒãƒ¼ãƒˆ9000ã§èµ·å‹•ã—ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚  
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã€ãƒ¡ãƒ¢ã‚’è¡Œã†ã€‚

```
[1] 2147

Formatting 1st pool, 1 set(s), 1 drives per set.
WARNING: Host local has more than 0 drives of set. A host failure will result in data becoming unavailable.
MinIO Object Storage Server
Copyright: 2015-2024 MinIO, Inc.
License: GNU AGPLv3 - https://www.gnu.org/licenses/agpl-3.0.html
Version: RELEASE.2024-06-13T22-53-53Z (go1.22.4 linux/amd64)

API: http://10.151.0.1:9000  http://127.0.0.1:9000
   RootUser: minioadmin
   RootPass: minioadmin

WebUI: http://10.151.0.1:43087 http://127.0.0.1:43087
   RootUser: minioadmin
   RootPass: minioadmin

CLI: https://min.io/docs/minio/linux/reference/minio-mc.html#quickstart
   $ mc alias set 'myminio' 'http://10.151.0.1:9000' 'minioadmin' 'minioadmin'

Docs: https://min.io/docs/minio/linux/index.html
Status:         1 Online, 0 Offline.
STARTUP WARNINGS:
- Detected default credentials 'minioadmin:minioadmin', we recommend that you change these values with 'MINIO_ROOT_USER' and 'MINIO_ROOT_PASSWORD' environment variables
- The standard parity is set to 0. This can lead to data loss.
```

ã“ã“ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ (`minioadmin`) ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ (`minioadmin`) ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

### MinIOã®ã‚·ã‚¹ãƒ†ãƒ ã‚µãƒ¼ãƒ“ã‚¹åŒ–

MinIOã‚’ã‚·ã‚¹ãƒ†ãƒ ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦è¨­å®šã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼ãŒå†èµ·å‹•ã—ã¦ã‚‚è‡ªå‹•çš„ã«èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

```bash
sudo vi /etc/systemd/system/minio.service
```

ä»¥ä¸‹ã®å†…å®¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã™ã‚‹ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã¯å…ˆã»ã©ã®ã‚‚ã®ã‚’ä½¿ç”¨ã™ã‚‹ï¼‰ï¼š

```ini
[Unit]
Description=MinIO
Documentation=https://docs.min.io
Wants=network-online.target
After=network-online.target

[Service]
User=root
Group=root
ExecStart=/usr/local/bin/minio server /opt/minio/data
Restart=always
RestartSec=10s
Environment="MINIO_ACCESS_KEY=minioadmin"
Environment="MINIO_SECRET_KEY=minioadmin"
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
```

ã‚µãƒ¼ãƒ“ã‚¹ã®æœ‰åŠ¹åŒ–ã¨èµ·å‹•ã‚’è¡Œã†ã€‚

```bash
sudo systemctl daemon-reload
sudo systemctl enable minio
sudo systemctl start minio
```

## Webãƒ–ãƒ©ã‚¦ã‚¶ã§MinIOã«ã‚¢ã‚¯ã‚»ã‚¹

Webãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ãã€[http://<ã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹>:9000](http://<ã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹>:9000) ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚  
å…ˆã»ã©ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã€‚

# MLFlow Serverã®è¨­å®š

MLFlowã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€è¨­å®šã‚’è¡Œã†ã€‚

## å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨æ›´æ–°

```bash
sudo apt update
```

## MLFlowã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Pythonã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«pipã‚’ä½¿ç”¨ã—ã¦MLFlowã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```bash
sudo pip3 install mlflow psycopg2-binary
```

## PostgreSQLã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®š

MLFlowã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã¨ã—ã¦PostgreSQLã‚’ä½¿ç”¨ã™ã‚‹ã€‚

### PostgreSQLã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
sudo apt install -y postgresql postgresql-contrib
```

### PostgreSQLã®è¨­å®š

PostgreSQLã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆpostgresï¼‰ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’è¨­å®šã™ã‚‹ã€‚

```bash
sudo -u postgres psql
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã€‚

```sql
CREATE DATABASE mlflow;
CREATE USER mlflow_user WITH ENCRYPTED PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE mlflow TO mlflow_user;
\q
```

PostgreSQLã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦å¤–éƒ¨ã‹ã‚‰ã®æ¥ç¶šã‚’è¨±å¯ã™ã‚‹ã€‚

```bash
sudo vi /etc/postgresql/14/main/pg_hba.conf
```

ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ«å°¾ã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹ï¼š

```conf
host    all             all             0.0.0.0/0               md5
```

æ¬¡ã«ã€PostgreSQLãŒå¤–éƒ¨ã‹ã‚‰æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãƒªã‚¹ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®šã™ã‚‹ã€‚

```bash
sudo vi /etc/postgresql/14/main/postgresql.conf
```

`listen_addresses` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã™ã‚‹ã€‚

```conf
listen_addresses = '*'
```

è¨­å®šã‚’åæ˜ ã™ã‚‹ãŸã‚ã«PostgreSQLã‚’å†èµ·å‹•ã™ã‚‹ã€‚

```bash
sudo systemctl restart postgresql
```

## MLFlowã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šã¨èµ·å‹•

### MLFlowã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦MLFlowã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã€‚  
ã“ã“ã§ã€PostgreSQLã®URLã¨MinIOã®URLã‚’æŒ‡å®šã™ã‚‹ã€‚

```bash
mlflow server \
    --backend-store-uri postgresql://mlflow_user:your_password@localhost/mlflow \
    --default-artifact-root s3://10.151.0.1 \
    --host 0.0.0.0 \
    --port 5000
```

your-bucketã¯MinIOã®ãƒã‚±ãƒƒãƒˆåã«ç½®ãæ›ãˆã‚‹ã“ã¨ã€‚

### ç’°å¢ƒå¤‰æ•°ã®è¨­å®šï¼ˆMinIOï¼‰

MLFlowãŒMinIOã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã€MinIOã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã™ã‚‹ã€‚

```bash
export MLFLOW_S3_ENDPOINT_URL=http://10.151.0.1:9000
export AWS_ACCESS_KEY_ID=your-minio-access-key
export AWS_SECRET_ACCESS_KEY=your-minio-secret-key
```

export AWS_ACCESS_KEY_ID=minioadmin
export AWS_SECRET_ACCESS_KEY=minioadmin


ã“ã“ã§ã€`your-minio-access-key`ãŠã‚ˆã³`your-minio-secret-key`ã¯ã€ã¨ã‚‚ã«`minioadmin`ã¨ãªã‚‹ã€‚

# MLFlow Clientã®è¨­å®š

MLFlow Clientã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã€MLFlow Serverã«æ¥ç¶šã™ã‚‹ã€‚

## MLFlow Clientã«MLFlowã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

pipã§ä»¥ä¸‹ã®é€šã‚Šã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

```bash
pip3 install mlflow boto3
```

## MLFlow Clientã®ç’°å¢ƒå¤‰æ•°è¨­å®š

MLFlow ClientãŒMLFlow Serverã«æ¥ç¶šã™ã‚‹ãŸã‚ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹ã€‚

```bash
export MLFLOW_TRACKING_URI=http://<mlflow-server-ip>:5000
```

ã“ã‚Œã§ã€MLFlowãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
